<!DOCTYPE html>
<html>
<head>
    <title>MH Wilds Total Damage Calculator (Detailed)</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0"> <style>
        body { font-family: sans-serif; margin: 0; padding: 20px; line-height: 1.5; background-color: #f4f4f4;}
        .container { max-width: 960px; margin: 0 auto; background-color: #fff; padding: 20px; border-radius: 8px; box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);} /* コンテンツを中央寄せ */
        label { display: inline-block; width: 280px; margin-bottom: 5px; font-weight: bold; }
        input[type="number"], input[type="text"], select {
             width: 150px; /* デフォルト幅を調整 */
             padding: 8px;
             border: 1px solid #ccc;
             border-radius: 4px;
             margin-bottom: 10px;
             box-sizing: border-box; /* paddingとborderを幅に含める */
        }
         input[type="number"] { width: 80px; margin-right: 10px; } /* 数値入力の幅を調整 */

        input[type="checkbox"] { margin-bottom: 5px; transform: scale(1.2); margin-right: 5px; vertical-align: middle; }

        button {
            padding: 10px 20px;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            margin-top: 15px;
            margin-right: 10px;
            transition: background-color 0.3s ease;
        }
        button:hover { background-color: #45a049; }
        button.save-button { background-color: #007bff; }
        button.save-button:hover { background-color: #0056b3; }
         button.load-button { background-color: #ffc107; color: #212529;}
         button.load-button:hover { background-color: #e0a800; }
         button.delete-button { background-color: #dc3545; }
         button.delete-button:hover { background-color: #c82333; }
         button.secondary-button { background-color: #6c757d; margin-top: 0; } /* モーダル内のボタン用 */
         button.secondary-button:hover { background-color: #5a6268; }


        .section-title { margin-top: 20px; margin-bottom: 10px; font-weight: bold; border-bottom: 2px solid #eee; padding-bottom: 5px; font-size: 1.2em;}
        #results { margin-top: 30px; padding: 15px; border: 1px solid #ddd; border-radius: 5px; background-color: #f9f9f9; }
        #results h3 { margin-top: 0; color: #333; border-bottom: 1px solid #eee; padding-bottom: 5px; }
        #results p { margin-bottom: 5px; }

        .attack-list { margin-bottom: 15px; }
        .attack-list label { width: auto; margin-right: 15px; margin-bottom: 8px; font-weight: normal; } /* モーション名のラベル幅を自動に */
        .attack-group-title { font-weight: bold; margin-top: 10px; margin-bottom: 5px; border-bottom: 1px dotted #ccc; padding-bottom: 2px;}

         .skill-category-title { font-weight: bold; margin-top: 15px; margin-bottom: 8px; border-bottom: 1px solid #ddd; padding-bottom: 3px; }
        .skill-item { margin-bottom: 8px; display: flex; align-items: center;} /* 各スキル項目をflexboxで横並びに */
        .skill-item label { width: 180px; font-weight: normal; margin-bottom: 0; } /* スキル名ラベルの幅固定 */
         .skill-item select { margin-left: auto; flex-shrink: 0; } /* レベル選択ドロップダウン */
         .skill-item input[type="checkbox"] { flex-shrink: 0; }

        /* --- Modal Styles --- */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .modal-overlay.visible {
            display: flex;
        }

        .modal-dialog {
            background-color: #fff;
            padding: 25px;
            border-radius: 8px;
            width: 90%; /* スマホ考慮して幅を%に */
            max-width: 500px; /* PCでの最大幅 */
            box-shadow: 0 0 15px rgba(0, 0, 0, 0.2);
            position: relative;
        }

        .modal-dialog h3 {
             margin-top: 0;
             margin-bottom: 15px;
             border-bottom: 1px solid #eee;
             padding-bottom: 8px;
        }

         .modal-dialog .close-button {
            position: absolute;
            top: 10px;
            right: 10px;
            font-size: 1.5em;
            border: none;
            background: none;
            cursor: pointer;
            padding: 5px;
            margin: 0;
         }
         .modal-dialog .close-button:hover {
            color: #dc3545;
         }

        .modal-dialog .control-group {
            margin-bottom: 15px;
            padding-bottom: 15px;
            border-bottom: 1px dotted #ccc;
        }
         .modal-dialog .control-group:last-child {
             border-bottom: none;
             padding-bottom: 0;
         }

        .modal-dialog .control-group label {
            width: auto; /* モーダル内のラベル幅自動 */
            margin-right: 10px;
            font-weight: normal;
        }
         .modal-dialog .control-group input[type="text"],
         .modal-dialog .control-group select {
             width: auto; /* モーダル内の入力/選択幅自動 */
             flex-grow: 1; /* 必要に応じて幅を広げる */
         }
         .modal-dialog .control-group div {
             display: flex;
             align-items: center;
             margin-bottom: 8px;
         }
         .modal-dialog .control-group div:last-child {
             margin-bottom: 0;
         }


        /* --- Responsive Styles --- */
        @media (max-width: 768px) {
            body { padding: 10px; }
             .container { padding: 15px; }

            label {
                width: 100%; /* 狭い画面ではラベルを100%幅に */
                margin-bottom: 5px;
            }
            input[type="number"], input[type="text"], select {
                 width: 100%; /* 入力フィールドも100%幅に */
                 margin-right: 0;
                 margin-bottom: 10px;
            }
             input[type="number"] { width: 100%; } /* 個別指定も100%に */

            button {
                 width: 100%; /* ボタンも100%幅に */
                 margin-right: 0;
                 margin-bottom: 10px;
            }
             button:last-child { margin-bottom: 0; } /* 最後のボタンの下余白調整 */
             button.secondary-button { margin-bottom: 10px; }

            .skill-item {
                flex-direction: column; /* スキル項目を縦並びに */
                align-items: flex-start; /* 左寄せ */
            }
             .skill-item label { width: 100%; margin-bottom: 5px; } /* ラベルも100%幅 */
             .skill-item select { margin-left: 0; width: 100%; } /* ドロップダウンも100%幅 */
             .skill-item input[type="checkbox"] { flex-shrink: 0; }


             .modal-dialog {
                width: 95%; /* さらに狭く */
                padding: 15px;
             }
             .modal-dialog .control-group div {
                 flex-direction: column; /* モーダル内の要素も縦積みに */
                 align-items: flex-start;
             }
              .modal-dialog .control-group label { width: 100%; margin-bottom: 5px;}
              .modal-dialog .control-group input[type="text"],
              .modal-dialog .control-group select { width: 100%; margin-right: 0; margin-bottom: 8px;}
         }


    </style>
</head>
<body>
    <div class="container">

        <h2>MH Wilds 太刀 合計ダメージ計算ツール (詳細版)</h2>
        <p>選択した攻撃モーションの連携による合計ダメージを計算します。</p>
        <p>入力項目とスキルレベルを調整し、連携に含めたい攻撃にチェックを入れて「合計ダメージを計算」ボタンを押してください。</p>
        <p>※モーション値・スキル効果・斬れ味補正値はコミュニティの検証情報に基づき、製品版と異なる場合があります。</p> <div class="section-title">武器基本性能</div>
        <div><label for="baseRaw">武器基礎攻撃力:</label><input type="number" id="baseRaw" value="220"></div>
        <div><label for="baseAffinity">武器基礎会心率 (%):</label><input type="number" id="baseAffinity" value="5"></div>
        <div><label for="baseDisplayElem">武器表示属性値:</label><input type="number" id="baseDisplayElem" value="350"></div>
         <div>
             <label for="sharpnessColor">斬れ味:</label>
             <select id="sharpnessColor">
                 <option value="yellow">黄</option>
                 <option value="green">緑</option>
                 <option value="blue">青</option>
                 <option value="white" selected>白</option>
                 </select>
         </div>
        <div class="section-title">モンスター肉質 (歴戦王レダウ 想定)</div>
        <div><label for="hitzoneRawHead">頭部 物理肉質:</label><input type="number" id="hitzoneRawHead" value="60"></div>
        <div><label for="hitzoneElemHead">頭部 属性肉質:</label><input type="number" id="hitzoneElemHead" value="20"></div>
        <div><label for="hitzoneRawLeg">足部 物理肉質:</label><input type="number" id="hitzoneRawLeg" value="37"></div>
        <div><label for="hitzoneElemLeg">足部 属性肉質:</label><input type="number" id="hitzoneElemLeg" value="10"></div>
        <div><label for="isLegHardTarget">足部を硬い部位として扱う (心眼適用判定):</label><input type="checkbox" id="isLegHardTarget" checked></div>

        <div class="section-title">スキル設定</div>
        <p>※チェックで有効/無効を切り替え、ドロップダウンでレベルを選択してください。</p>

        <div class="skill-category-title">武器スキル</div>
        <div class="skill-item">
            <input type="checkbox" id="skillAttackToggle" data-skill-id="attack">
            <label for="skillAttackToggle">攻撃</label>
             <select id="skillAttackLevelSelect" data-skill-id="attack" disabled>
                 <option value="0">Lv0</option><option value="1">Lv1</option><option value="2">Lv2</option><option value="3">Lv3</option><option value="4">Lv4</option><option value="5">Lv5</option><option value="6">Lv6</option><option value="7" selected>Lv7</option>
             </select>
        </div>
        <div class="skill-item">
            <input type="checkbox" id="skillCriticalEyeToggle" data-skill-id="criticalEye">
            <label for="skillCriticalEyeToggle">見切り</label>
             <select id="skillCriticalEyeLevelSelect" data-skill-id="criticalEye" disabled>
                 <option value="0">Lv0</option><option value="1">Lv1</option><option value="2">Lv2</option><option value="3">Lv3</option><option value="4">Lv4</option><option value="5">Lv5</option><option value="6">Lv6</option><option value="7" selected>Lv7</option>
             </select>
        </div>
        <div class="skill-item">
            <input type="checkbox" id="skillCritBoostToggle" data-skill-id="critBoost">
            <label for="skillCritBoostToggle">超会心</label>
             <select id="skillCritBoostLevelSelect" data-skill-id="critBoost" disabled>
                 <option value="0">Lv0</option><option value="1">Lv1</option><option value="2">Lv2</option><option value="3">Lv3</option><option value="4">Lv4</option><option value="5" selected>Lv5</option>
             </select>
        </div>
        <div class="skill-item">
            <input type="checkbox" id="skillMindsEyeToggle" data-skill-id="mindsEye">
            <label for="skillMindsEyeToggle">心眼</label>
             <select id="skillMindsEyeLevelSelect" data-skill-id="mindsEye" disabled>
                 <option value="0">Lv0</option><option value="1">Lv1</option><option value="2">Lv2</option><option value="3" selected>Lv3</option>
             </select>
        </div>
        <div class="skill-item">
            <input type="checkbox" id="skillCritElemToggle" data-skill-id="critElem">
            <label for="skillCritElemToggle">会心撃【属性】</label>
             <select id="skillCritElemLevelSelect" data-skill-id="critElem" disabled>
                 <option value="0">Lv0</option><option value="1">Lv1</option><option value="2">Lv2</option><option value="3">Lv3</option><option value="4">Lv4</option><option value="5" selected>Lv5</option>
             </select>
        </div>
        <p>※武器固有のRaw/属性値スキルは入力項目に移動しました。</p>

        <div class="skill-category-title">防具スキル</div>
        <div class="skill-item">
            <input type="checkbox" id="skillPeakPerformanceToggle" data-skill-id="peakPerformance">
            <label for="skillPeakPerformanceToggle">フルチャージ</label>
             <select id="skillPeakPerformanceLevelSelect" data-skill-id="peakPerformance" disabled>
                 <option value="0">Lv0</option><option value="1">Lv1</option><option value="2">Lv2</option><option value="3">Lv3</option><option value="4">Lv4</option><option value="5" selected>Lv5</option>
             </select>
        </div>
        <div class="skill-item">
            <input type="checkbox" id="skillInverseToggle" data-skill-id="inverse">
            <label for="skillInverseToggle">逆襲</label>
             <select id="skillInverseLevelSelect" data-skill-id="inverse" disabled>
                 <option value="0">Lv0</option><option value="1">Lv1</option><option value="2">Lv2</option><option value="3" selected>Lv3</option>
             </select>
        </div>
         <div class="skill-item">
            <input type="checkbox" id="skillAgitatorToggle" data-skill-id="agitator">
            <label for="skillAgitatorToggle">挑戦者</label>
             <select id="skillAgitatorLevelSelect" data-skill-id="agitator" disabled>
                 <option value="0">Lv0</option><option value="1">Lv1</option><option value="2">Lv2</option><option value="3">Lv3</option><option value="4">Lv4</option><option value="5" selected>Lv5</option>
             </select>
        </div>
         <div class="skill-item">
            <input type="checkbox" id="skillMaximumMightToggle" data-skill-id="maximumMight">
            <label for="skillMaximumMightToggle">渾身</label>
             <select id="skillMaximumMightLevelSelect" data-skill-id="maximumMight" disabled>
                 <option value="0">Lv0</option><option value="1">Lv1</option><option value="2">Lv2</option><option value="3" selected>Lv3</option>
             </select>
        </div>
         <div class="skill-item">
            <input type="checkbox" id="skillLatentPowerToggle" data-skill-id="latentPower">
            <label for="skillLatentPowerToggle">力の解放</label>
             <select id="skillLatentPowerLevelSelect" data-skill-id="latentPower" disabled>
                 <option value="0">Lv0</option><option value="1">Lv1</option><option value="2">Lv2</option><option value="3">Lv3</option><option value="4">Lv4</option><option value="5" selected>Lv5</option>
             </select>
        </div>
         <div class="skill-item">
            <input type="checkbox" id="skillChainCritToggle" data-skill-id="chainCrit">
            <label for="skillChainCritToggle">連撃</label>
             <select id="skillChainCritLevelSelect" data-skill-id="chainCrit" disabled>
                 <option value="0">Lv0</option><option value="1">Lv1</option><option value="2">Lv2</option><option value="3" selected>Lv3</option>
             </select>
        </div>
         <div class="skill-item">
            <input type="checkbox" id="skillOffensiveGuardToggle" data-skill-id="offensiveGuard">
            <label for="skillOffensiveGuardToggle">巧撃</label>
             <select id="skillOffensiveGuardLevelSelect" data-skill-id="offensiveGuard" disabled>
                 <option value="0">Lv0</option><option value="1">Lv1</option><option value="2">Lv2</option><option value="3" selected>Lv3</option>
             </select>
        </div>
         <div class="skill-item">
            <input type="checkbox" id="skillAbsorptionToggle" data-skill-id="absorption">
            <label for="skillAbsorptionToggle">属性吸収</label>
             <select id="skillAbsorptionLevelSelect" data-skill-id="absorption" disabled>
                 <option value="0">Lv0</option><option value="1">Lv1</option><option value="2">Lv2</option><option value="3" selected>Lv3</option>
             </select>
        </div>
        <div class="skill-item">
            <input type="checkbox" id="skillWeaknessExploitToggle" data-skill-id="weaknessExploit">
            <label for="skillWeaknessExploitToggle">弱点特攻</label>
             <select id="skillWeaknessExploitLevelSelect" data-skill-id="weaknessExploit" disabled>
                 <option value="0">Lv0</option><option value="1">Lv1</option><option value="2">Lv2</option><option value="3">Lv3</option><option value="4">Lv4</option><option value="5" selected>Lv5</option>
             </select>
        </div>


        <div class="skill-category-title">グループスキル (セットボーナス等)</div>
        <div class="skill-item">
             <input type="checkbox" id="skillNushiNoTamashiiToggle" data-skill-id="nushiNoTamashii">
             <label for="skillNushiNoTamashiiToggle">ヌシの魂 Lv1 (根性【果敢】発動前)</label>
             </div>


        <div class="section-title">攻撃連携シミュレーション</div>
        <p>連携に含めたい攻撃にチェックを入れてください。選択された攻撃の合計ダメージを計算します。<br>※多段ヒット攻撃は「1ヒットあたりのMV」と「合計ヒット数」を元に、攻撃全体の合計ダメージを計算します。</p>
        <div class="attack-list">
            <div class="attack-group-title">基本攻撃</div>
            <label><input type="checkbox" class="attack-checkbox" data-mv="0.24" data-hits="1" data-name="縦斬り"> 縦斬り (MV: 0.24)</label><br>
            <label><input type="checkbox" class="attack-checkbox" data-mv="0.18" data-hits="1" data-name="縦斬り(2)"> 縦斬り(2) (MV: 0.18)</label><br>
            <label><input type="checkbox" class="attack-checkbox" data-mv="0.32" data-hits="1" data-name="逆袈裟斬り"> 逆袈裟斬り (MV: 0.32)</label><br>
            <label><input type="checkbox" class="attack-checkbox" data-mv="0.18" data-hits="1" data-name="突き"> 突き (MV: 0.18)</label><br>
            <label><input type="checkbox" class="attack-checkbox" data-mv="0.18" data-hits="1" data-name="斬り上げ"> 斬り上げ (MV: 0.18)</label><br>
            <label><input type="checkbox" class="attack-checkbox" data-mv="0.22" data-hits="1" data-name="斬り下がり"> 斬り下がり (MV: 0.22)</label><br>
            <label><input type="checkbox" class="attack-checkbox" data-mv="0.22" data-hits="1" data-name="左右移動斬り"> 左右移動斬り (MV: 0.22)</label><br>
             <label><input type="checkbox" class="attack-checkbox" data-mv="0.26" data-hits="1" data-name="気刃斬りI"> 気刃斬りI (MV: 0.26)</label><br> <label><input type="checkbox" class="attack-checkbox" data-mv="0.30" data-hits="1" data-name="赤刃斬りI"> 赤刃斬りI (MV: 0.30)</label><br> <div class="attack-group-title">気刃斬り連携</div>
            <label><input type="checkbox" class="attack-checkbox" data-mv="0.28" data-hits="1" data-name="気刃踏み込み斬り"> 気刃踏み込み斬り (MV: 0.28)</label><br>
            <label><input type="checkbox" class="attack-checkbox" data-mv="0.14" data-hits="1" data-name="気刃斬りⅠ(ゲージ無し)"> 気刃斬りⅠ(ゲージ無し) (MV: 0.14)</label><br>
            <label><input type="checkbox" class="attack-checkbox" data-mv="0.31" data-hits="1" data-name="気刃斬りⅠ"> 気刃斬りⅠ (MV: 0.31)</label><br>
            <label><input type="checkbox" class="attack-checkbox" data-mv="0.30" data-hits="1" data-name="気刃斬りⅡ"> 気刃斬りⅡ (MV: 0.30)</label><br>
            <label><input type="checkbox" class="attack-checkbox" data-mv="0.14" data-hits="1" data-name="気刃斬りⅡ(移動) ヒット1"> 気刃斬りⅡ(移動) ヒット1 (MV: 0.14)</label><br>
            <label><input type="checkbox" class="attack-checkbox" data-mv="0.26" data-hits="1" data-name="気刃斬りⅡ(移動) ヒット2"> 気刃斬りⅡ(移動) ヒット2 (MV: 0.26)</label><br>
            <label><input type="checkbox" class="attack-checkbox" data-mv="0.14" data-hits="1" data-name="気刃斬りⅢ ヒット1"> 気刃斬りⅢ ヒット1 (MV: 0.14)</label><br>
            <label><input type="checkbox" class="attack-checkbox" data-mv="0.19" data-hits="1" data-name="気刃斬りⅢ ヒット2"> 気刃斬りⅢ ヒット2 (MV: 0.19)</label><br>
            <label><input type="checkbox" class="attack-checkbox" data-mv="0.34" data-hits="1" data-name="気刃斬りⅢ ヒット3"> 気刃斬りⅢ ヒット3 (MV: 0.34)</label><br>
            <label><input type="checkbox" class="attack-checkbox" data-mv="0.38" data-hits="1" data-name="気刃大回転斬り"> 気刃大回転斬り (MV: 0.38)</label><br>
             <div class="attack-group-title">居合・見切り・赤刃</div>
            <label><input type="checkbox" class="attack-checkbox" data-mv="0.18" data-hits="1" data-name="居合抜刀斬り ヒット1"> 居合抜刀斬り ヒット1 (MV: 0.18)</label><br>
            <label><input type="checkbox" class="attack-checkbox" data-mv="0.13" data-hits="1" data-name="居合抜刀斬り ヒット2"> 居合抜刀斬り ヒット2 (MV: 0.13)</label><br>
            <label><input type="checkbox" class="attack-checkbox" data-mv="0.17" data-hits="1" data-name="居合抜刀気刃斬り (ゲージ無し?)"> 居合抜刀気刃斬り (MV: 0.17)</label><br>
            <label><input type="checkbox" class="attack-checkbox" data-mv="0.19" data-hits="1" data-name="居合抜刀気刃斬り白"> 居合抜刀気刃斬り白 (MV: 0.19)</label><br>
            <label><input type="checkbox" class="attack-checkbox" data-mv="0.31" data-hits="1" data-name="居合抜刀気刃斬り黄"> 居合抜刀気刃斬り黄 (MV: 0.31)</label><br>
            <label><input type="checkbox" class="attack-checkbox" data-mv="0.39" data-hits="1" data-name="居合抜刀気刃斬り赤"> 居合抜刀気刃斬り赤 (MV: 0.39)</label><br>
            <label><input type="checkbox" class="attack-checkbox" data-mv="0.11" data-hits="1" data-name="見切り斬り"> 見切り斬り (MV: 0.11)</label><br>
            <label><input type="checkbox" class="attack-checkbox" data-mv="0.20" data-hits="1" data-name="見切り斬り・旋 ヒット1"> 見切り斬り・旋 ヒット1 (MV: 0.20)</label><br>
            <label><input type="checkbox" class="attack-checkbox" data-mv="0.12" data-hits="1" data-name="見切り斬り・旋 ヒット2"> 見切り斬り・旋 ヒット2 (MV: 0.12)</label><br>
            <label><input type="checkbox" class="attack-checkbox" data-mv="0.09" data-hits="1" data-name="赤刃斬りⅡ ヒット1"> 赤刃斬りⅡ ヒット1 (MV: 0.09)</label><br>
            <label><input type="checkbox" class="attack-checkbox" data-mv="0.18" data-hits="1" data-name="赤刃斬りⅡ ヒット2"> 赤刃斬りⅡ ヒット2 (MV: 0.18)</label><br>
            <label><input type="checkbox" class="attack-checkbox" data-mv="0.28" data-hits="1" data-name="赤刃斬りⅢ ヒット1"> 赤刃斬りⅢ ヒット1 (MV: 0.28)</label><br>
            <label><input type="checkbox" class="attack-checkbox" data-mv="0.16" data-hits="1" data-name="赤刃斬りⅢ ヒット2"> 赤刃斬りⅢ ヒット2 (MV: 0.16)</label><br>
            <label><input type="checkbox" class="attack-checkbox" data-mv="0.49" data-hits="1" data-name="赤刃斬りⅢ ヒット3"> 赤刃斬りⅢ ヒット3 (MV: 0.49)</label><br>
            <label><input type="checkbox" class="attack-checkbox" data-mv="0.55" data-hits="1" data-name="赤刃旋転斬"> 赤刃旋転斬 (MV: 0.55)</label><br>


            <div class="attack-group-title">特殊系</div>
             <label><input type="checkbox" class="attack-checkbox" data-mv="0.05" data-hits="3" data-name="練気解放無双斬り MV5"> 練気解放無顔斬り MV5 (MV: 0.05 x 3ヒット)</label><br>
             <label><input type="checkbox" class="attack-checkbox" data-mv="0.10" data-hits="3" data-name="練気解放無双斬り MV10"> 練気解放無顔斬り MV10 (MV: 0.10 x 3ヒット)</label><br>
             <label><input type="checkbox" class="attack-checkbox" data-mv="0.16" data-hits="3" data-name="練気解放無双斬り MV16"> 練気解放無顔斬り MV16 (MV: 0.16 x 3ヒット)</label><br>
             <label><input type="checkbox" class="attack-checkbox" data-mv="0.22" data-hits="3" data-name="練気解放無双斬り MV22"> 練気解放無顔斬り MV22 (MV: 0.22 x 3ヒット)</label><br>
             <label><input type="checkbox" class="attack-checkbox" data-mv="0.36" data-hits="3" data-name="練気解放無双斬り MV36"> 練気解放無顔斬り MV36 (MV: 0.36 x 3ヒット)</label><br>

             <label><input type="checkbox" class="attack-checkbox" data-mv="0.15" data-hits="7" data-name="気刃兜割 白"> 気刃兜割 白 (MV: 0.15 x 7ヒット)</label><br>
            <label><input type="checkbox" class="attack-checkbox" data-mv="0.20" data-hits="7" data-name="気刃兜割 黄"> 気刃兜割 黄 (MV: 0.20 x 7ヒット)</label><br>
            <label><input type="checkbox" class="attack-checkbox" data-mv="0.23" data-hits="7" data-name="気刃兜割 赤"> 気刃兜割 赤 (MV: 0.23 x 7ヒット)</label><br>

             <label><input type="checkbox" class="attack-checkbox" data-mv="0.18" data-hits="1" data-name="気刃突き"> 気刃突き (MV: 0.18)</label><br>

            <div class="attack-group-title">ジャンプ攻撃・騎乗</div>
            <label><input type="checkbox" class="attack-checkbox" data-mv="0.18" data-hits="1" data-name="ジャンプ斬り"> ジャンプ斬り (MV: 0.18)</label><br>
            <label><input type="checkbox" class="attack-checkbox" data-mv="0.20" data-hits="1" data-name="ジャンプ斬り上げ"> ジャンプ斬り上げ (MV: 0.20)</label><br>
            <label><input type="checkbox" class="attack-checkbox" data-mv="0.16" data-hits="1" data-name="ジャンプ気刃斬りⅠ(ゲージ無し)"> ジャンプ気刃斬りⅠ(ゲージ無し) (MV: 0.16)</label><br>
            <label><input type="checkbox" class="attack-checkbox" data-mv="0.30" data-hits="1" data-name="ジャンプ気刃斬りⅠ"> ジャンプ気刃斬りⅠ (MV: 0.30)</label><br>
            <label><input type="checkbox" class="attack-checkbox" data-mv="0.15" data-hits="1" data-name="騎乗攻撃1 ヒット1"> 騎乗攻撃1 ヒット1 (MV: 0.15)</label><br>
            <label><input type="checkbox" class="attack-checkbox" data-mv="0.10" data-hits="1" data-name="騎乗攻撃1 ヒット2"> 騎乗攻撃1 ヒット2 (MV: 0.10)</label><br>
            <label><input type="checkbox" class="attack-checkbox" data-mv="0.20" data-hits="1" data-name="騎乗攻撃2"> 騎乗攻撃2 (MV: 0.20)</label><br>
            <label><input type="checkbox" class="attack-checkbox" data-mv="0.30" data-hits="1" data-name="下乗攻撃 ヒット1"> 下乗攻撃 ヒット1 (MV: 0.30)</label><br>
            <label><input type="checkbox" class="attack-checkbox" data-mv="0.15" data-hits="1" data-name="下乗攻撃 ヒット2"> 下乗攻撃 ヒット2 (MV: 0.15)</label><br>


        </div>


        <div class="section-title">シミュレーション設定</div>
        <button class="secondary-button" onclick="openSettingsModal()">設定の保存・読み込み・削除</button>


        <button onclick="calculateTotalDamage()">合計ダメージを計算</button>

        <div id="results"></div>

    </div> <div id="settingsModalOverlay" class="modal-overlay">
        <div id="settingsModalDialog" class="modal-dialog">
            <button class="close-button" onclick="closeSettingsModal()">&times;</button>
            <h3>設定の保存・読み込み・削除</h3>

            <div class="control-group">
                <div>
                    <label for="settingNameInput">設定名:</label>
                    <input type="text" id="settingNameInput" placeholder="新しい設定名">
                </div>
                <button class="save-button secondary-button" onclick="saveCurrentSettings()">現在の設定を保存</button>
            </div>

            <div class="control-group">
                 <div>
                    <label for="savedSettingsSelect">保存済み設定:</label>
                    <select id="savedSettingsSelect">
                        <option value="">--選択してください--</option>
                    </select>
                 </div>
                <button class="load-button secondary-button" onclick="loadSelectedSetting()">読み込み</button>
                <button class="delete-button secondary-button" onclick="deleteSelectedSetting()">削除</button>
            </div>

            <div class="control-group">
                 <button class="clear-button secondary-button" onclick="clearAllSettings()">全ての保存設定をクリア</button>
            </div>

        </div>
    </div>
    <script>
        // Define a key for localStorage
        const localStorageKey = 'mhwilds_ls_calculator_multiple_settings_v8'; // キーを更新して変更を反映

        // Global variable to hold all settings
        let allSettings = {};

        // --- Skill Data Mapping (Level Effects) ---
        const skillData = {
            attack: { raw: [0, 3, 5, 7, 8, 8, 8, 8], multi: [1.0, 1.0, 1.0, 1.0, 1.02, 1.04, 1.06, 1.08] }, // Lv0-7
            criticalEye: { affinity: [0, 4, 8, 12, 16, 20, 25, 30] }, // Lv0-7
            peakPerformance: { raw: [0, 3, 6, 10, 15, 20] }, // Lv0-5
            inverse: { raw: [0, 10, 15, 25] }, // Lv0-3
            agitator: { raw: [0, 4, 8, 12, 16, 20], affinity: [0, 3, 5, 7, 10, 15] }, // Lv0-5
            maximumMight: { affinity: [0, 10, 20, 30] }, // Lv0-3
            latentPower: { affinity: [0, 10, 20, 30, 40, 50] }, // Lv0-5
            chainCrit: { raw: [0, 8, 12, 16], trueElem: [0, 6, 8, 10] }, // Lv0-3 (Stage 2 assumed)
            offensiveGuard: { raw: [0, 10, 15, 20] }, // Lv0-3
            absorption: { trueElem: [0, 4, 6, 8] }, // Lv0-3 (Assumed)
            weaknessExploit: { totalWoundedAff: [0, 8, 15, 25, 35, 50] }, // Lv0-5 (Effective + Wounded combined)
            critBoost: { totalMulti: [1.25, 1.28, 1.31, 1.34, 1.37, 1.40] }, // Lv0-5 (Base 1.25 + skill adds. Lv0 is 1.25)
            mindsEye: { hardMulti: [1.0, 1.10, 1.15, 1.30] }, // Lv0-3 (Lv0 is 1.0)
            critElem: { multi: [1.0, 1.05, 1.09, 1.16, 1.20, 1.25] }, // Lv0-5 (Lv0 is 1.0)
            nushiNoTamashii: { rawMultiplier: 1.05 } // Lv1 fixed multiplier
        };

        // --- Sharpness Multipliers Data ---
        // Based on community findings for Yellow, Green, Blue, White
        const sharpnessData = {
            yellow: { phys: 1.00, elem: 0.75 },
            green: { phys: 1.05, elem: 1.00 },
            blue: { phys: 1.20, elem: 1.0625 }, // Community value, might change
            white: { phys: 1.32, elem: 1.15 },
            // Red, Orange, Purple excluded for now
        };


        // Get results div element once on load
        let resultsDivElement;

        // Helper to safely parse float from element value
        const safeParseFloat = (id, defaultValue = 0) => {
            const element = document.getElementById(id);
            if (!element) { return defaultValue; }
            const value = parseFloat(element.value);
            return isNaN(value) ? defaultValue : value;
        };

        // Helper to safely parse int from element value
        const safeParseInt = (id, defaultValue = 0) => {
             const element = document.getElementById(id);
            if (!element) { return defaultValue; }
            const value = parseInt(element.value);
            return isNaN(value) ? defaultValue : value;
        };

        // Helper to safely get checkbox checked state
        const safeGetChecked = (id, defaultValue = false) => {
             const element = document.getElementById(id);
             if (!element || element.type !== 'checkbox') { return defaultValue; }
             return element.checked;
        };

        // Helper to safely get select element value
        const safeGetSelectValue = (id, defaultValue = '') => {
            const element = document.getElementById(id);
            if (!element || element.tagName !== 'SELECT') { return defaultValue; }
            return element.value;
        };


        // --- Helper Functions for Getting Input Values ---
        function getWeaponInputs() {
            const selectedSharpnessColor = safeGetSelectValue('sharpnessColor', 'white'); // Get selected sharpness color

            const inputs = {
                baseRaw: safeParseFloat('baseRaw', 0),
                baseAffinity: safeParseFloat('baseAffinity', 0),
                baseDisplayElem: safeParseFloat('baseDisplayElem', 0),
                sharpnessColor: selectedSharpnessColor, // Store selected color
                sharpnessPhys: sharpnessData[selectedSharpnessColor]?.phys ?? 1.0, // Get phys multiplier from data
                sharpnessElem: sharpnessData[selectedSharpnessColor]?.elem ?? 1.0, // Get elem multiplier from data
            };
            return inputs;
        }

        function getHitzoneInputs() {
             const inputs = {
                hitzoneRawHead: safeParseFloat('hitzoneRawHead', 0),
                hitzoneElemHead: safeParseFloat('hitzoneElemHead', 0),
                hitzoneRawLeg: safeParseFloat('hitzoneRawLeg', 0),
                hitzoneElemLeg: safeParseFloat('hitzoneElemLeg', 0),
                isLegHardTarget: safeGetChecked('isLegHardTarget', false),
             };
             return inputs;
        }

        function getSkillSettings() {
             const skillSettings = {};
             const skillToggles = document.querySelectorAll('.skill-item input[type="checkbox"][data-skill-id]');

             skillToggles.forEach(checkbox => {
                 const skillId = checkbox.dataset.skillId;
                 if (skillId) {
                     const levelSelect = document.getElementById(skillId + 'LevelSelect');
                     skillSettings[skillId] = {
                         enabled: checkbox.checked,
                         level: levelSelect ? safeParseInt(skillId + 'LevelSelect', 0) : 0
                     };
                 }
             });
             return skillSettings;
        }

        function getSelectedAttacks() {
            const selectedAttacks = {};
            const attackCheckboxes = document.querySelectorAll('.attack-checkbox');
            attackCheckboxes.forEach(checkbox => {
                if (checkbox.checked) {
                     const mv = parseFloat(checkbox.dataset.mv);
                     const hits = parseInt(checkbox.dataset.hits);
                     const attackName = checkbox.dataset.name;

                      if (isNaN(mv) || isNaN(hits) || hits < 1) {
                          console.error(`getSelectedAttacks: Invalid MV or Hits for attack "${attackName}"`, {mv, hits});
                      } else {
                          selectedAttacks[attackName] = { mv: mv, hits: hits };
                      }
                }
            });
            return selectedAttacks;
        }


        // --- Skill Effect Calculation ---
        function getCalculatedSkillEffects(skillSettings) {
             const effects = {
                 rawFlat: 0,
                 rawMultiplier: 1.0,
                 trueElemFlat: 0,
                 affinityAdd: 0,
                 critBoostMultiplier: skillData.critBoost.totalMulti[0],
                 mindsEyeMultiplierHard: skillData.mindsEye.hardMulti[0],
                 critElemMultiplier: skillData.critElem.multi[0],
                 nushiNoTamashiiRawMultiplier: 1.0,
                 wexAffinityHead: 0,
                 wexAffinityLeg: 0, // Redau Leg is not WEX spot
             };

             const getEffectValue = (level, values, skillName, effectType) => {
                 if (!Array.isArray(values) || values.length === 0) {
                     console.error(`getEffectValue: Invalid data for skill "${skillName}", effect "${effectType}".`);
                     return 0;
                 }
                 const effectiveLevel = Math.min(Math.max(0, level), values.length - 1);
                 const value = values[effectiveLevel];
                  if (isNaN(value) || !isFinite(value)) {
                       console.error(`getEffectValue: Invalid value (${value}) for skill "${skillName}", effect "${effectType}", level ${level}.`);
                       return 0;
                  }
                 return value;
             };

             for (const skillId in skillSettings) {
                 if (skillSettings.hasOwnProperty(skillId) && skillSettings[skillId].enabled) {
                     const level = skillSettings[skillId].level;
                     const data = skillData[skillId];

                     if (!data) {
                         console.warn(`Skill data not found for ID: ${skillId}`);
                         continue;
                     }

                     if (data.raw) effects.rawFlat += getEffectValue(level, data.raw, skillId, 'raw');
                     if (data.multi) effects.rawMultiplier *= getEffectValue(level, data.multi, skillId, 'multi');
                     if (data.trueElem) effects.trueElemFlat += getEffectValue(level, data.trueElem, skillId, 'trueElem');
                     if (data.affinity) effects.affinityAdd += getEffectValue(level, data.affinity, skillId, 'affinity');
                     if (data.totalMulti) effects.critBoostMultiplier = getEffectValue(level, data.totalMulti, skillId, 'totalMulti');
                     if (data.hardMulti) effects.mindsEyeMultiplierHard = getEffectValue(level, data.hardMulti, skillId, 'hardMulti');
                     if (data.critElem) effects.critElemMultiplier = getEffectValue(level, data.critElem, skillId, 'critElem');
                     if (data.totalWoundedAff) {
                          if (skillId === 'weaknessExploit') {
                             effects.wexAffinityHead = getEffectValue(level, data.totalWoundedAff, skillId, 'totalWoundedAff');
                             effects.wexAffinityLeg = 0;
                          }
                     }
                      if (data.rawMultiplier && skillId === 'nushiNoTamashii') {
                          effects.nushiNoTamashiiRawMultiplier = data.rawMultiplier;
                      }
                 }
             }
             return effects;
        }

        // --- Core Damage Calculations ---

        function calculateTrueRaw(baseRaw, skillEffects) {
             const trueRaw = (baseRaw * skillEffects.nushiNoTamashiiRawMultiplier + skillEffects.rawFlat) * skillEffects.rawMultiplier;
             return trueRaw;
        }

        function calculateEffectiveAffinity(baseAffinity, skillAffinityAdd, wexAffinity) {
            let totalAff = baseAffinity + skillAffinityAdd + wexAffinity;
            const effectiveAff = Math.min(Math.max(0, totalAff), 100);
            return effectiveAff;
        }

        function calculateTrueElemental(baseDisplayElem, skillTrueElemFlat) {
            const trueElem = (baseDisplayElem / 10) + skillTrueElemFlat;
            return trueElem;
        }


        function calculateDamagePerHit(
            trueRaw, trueElemental, motionValue, sharpnessPhys, sharpnessElem,
            hitzoneRaw, hitzoneElem, effectiveAffinity, critBoostMultiplier,
            mindsEyeMultiplierHard, critElemMultiplier, isTargetHard
        ) {
             // Check for NaN or Infinity in inputs - Done in main calculation

            // Physical Damage
            let basePhysDmg = trueRaw * motionValue * sharpnessPhys * (hitzoneRaw / 100);
             if (isTargetHard && mindsEyeMultiplierHard > skillData.mindsEye.hardMulti[0]) {
                 basePhysDmg *= mindsEyeMultiplierHard;
             }
            const affinityDecimal = Math.max(0, Math.min(100, effectiveAffinity)) / 100;
            const critExpectation = (1 - affinityDecimal) * 1.0 + affinityDecimal * critBoostMultiplier;
            const totalPhysDmgPerHit = basePhysDmg * critExpectation;

            // Elemental Damage
            const baseElemDmg = trueElemental * sharpnessElem * (hitzoneElem / 100);
            const critElemExpectation = (1 - affinityDecimal) * 1.0 + affinityDecimal * critElemMultiplier;
            const totalElemDmgPerHit = baseElemDmg * critElemExpectation;

            const totalDmg = totalPhysDmgPerHit + totalElemDmgPerHit;

             if (!isFinite(totalDmg)) {
                 console.error("calculateDamagePerHit: Calculated damage is not finite.", totalDmg);
                 return NaN;
             }
            return totalDmg;
        }


        // --- Main Calculation Function ---
        function calculateTotalDamage() {
            console.log("Calculation started.");

            if (!resultsDivElement) {
                 console.error("Results div element not found!");
                 alert("計算結果表示エリアが見つかりません。");
                 return;
            }

            const weaponInputs = getWeaponInputs(); // Includes selected sharpness phys/elem
            const hitzoneInputs = getHitzoneInputs();
            const skillSettings = getSkillSettings();
            const selectedAttacks = getSelectedAttacks();

            const selectedAttackNames = Object.keys(selectedAttacks);
            if (selectedAttackNames.length === 0) {
                 resultsDivElement.innerHTML = '<h3>計算結果</h3><p>計算対象の攻撃が選択されていません。</p>';
                 console.log("No attacks selected.");
                 return;
            }

             // Consolidated check for NaN/Infinity in primary inputs
             const primaryInputs = { ...weaponInputs, ...hitzoneInputs };
             if (Object.values(primaryInputs).some(val => typeof val === 'number' && !isFinite(val))) {
                  console.error("Primary inputs contain non-finite values.", primaryInputs);
                  resultsDivElement.innerHTML = '<h3>計算エラー</h3><p>入力値に無効なものがあります。数値が正しく入力されているか確認してください。</p>';
                   return;
              }

            const skillEffects = getCalculatedSkillEffects(skillSettings);
             // Check for NaN/Infinity in skill effects
             if (Object.values(skillEffects).some(val => typeof val === 'number' && !isFinite(val))) {
                  console.error("Calculated skill effects contain non-finite values.", skillEffects);
                   resultsDivElement.innerHTML = '<h3>計算エラー</h3><p>スキル効果の計算に問題が発生しました。</p>';
                   return;
             }


            const trueRaw = calculateTrueRaw(weaponInputs.baseRaw, skillEffects);
            const trueElemental = calculateTrueElemental(weaponInputs.baseDisplayElem, skillEffects.trueElemFlat);

             if (!isFinite(trueRaw) || !isFinite(trueElemental)) {
                  console.error("True Raw or True Elemental is not finite.", {trueRaw, trueElemental});
                   resultsDivElement.innerHTML = '<h3>計算エラー</h3><p>攻撃力・属性値の計算に問題が発生しました。</p>';
                   return;
             }


            const effectiveAffinityHead = calculateEffectiveAffinity(weaponInputs.baseAffinity, skillEffects.affinityAdd, skillEffects.wexAffinityHead);
            const effectiveAffinityLeg = calculateEffectiveAffinity(weaponInputs.baseAffinity, skillEffects.affinityAdd, skillEffects.wexAffinityLeg);

             if (!isFinite(effectiveAffinityHead) || !isFinite(effectiveAffinityLeg)) {
                  console.error("Effective Affinity is not finite.", {effectiveAffinityHead, effectiveAffinityLeg});
                   resultsDivElement.innerHTML = '<h3>計算エラー</h3><p>会心率の計算に問題が発生しました。</p>';
                   return;
             }


            let totalSequenceDamageHeadOnly = 0;
            let totalSequenceDamageLegOnly = 0;
            let calculationErrorOccurred = false;

            for (const attackName in selectedAttacks) {
                if (selectedAttacks.hasOwnProperty(attackName)) {
                     const attack = selectedAttacks[attackName];

                    const totalDmgHeadPerHit = calculateDamagePerHit(
                        trueRaw, trueElemental, attack.mv, weaponInputs.sharpnessPhys, weaponInputs.sharpnessElem, // Use sharpness from weaponInputs
                        hitzoneInputs.hitzoneRawHead, hitzoneInputs.hitzoneElemHead, effectiveAffinityHead,
                        skillEffects.critBoostMultiplier, skillEffects.mindsEyeMultiplierHard, skillEffects.critElemMultiplier,
                        false
                    );

                     if (!isFinite(totalDmgHeadPerHit)) {
                          console.error(`Damage per hit for ${attackName} on Head is not finite.`);
                          calculationErrorOccurred = true;
                     } else {
                         const totalDmgHeadForAttack = totalDmgHeadPerHit * attack.hits;
                          if (!isFinite(totalDmgHeadForAttack)) {
                              console.error(`Total damage for ${attackName} on Head is not finite.`);
                               calculationErrorOccurred = true;
                         } else {
                              totalSequenceDamageHeadOnly += totalDmgHeadForAttack;
                         }
                     }

                     const totalDmgLegPerHit = calculateDamagePerHit(
                        trueRaw, trueElemental, attack.mv, weaponInputs.sharpnessPhys, weaponInputs.sharpessElem, // Use sharpness from weaponInputs
                        hitzoneInputs.hitzoneRawLeg, hitzoneInputs.hitzoneElemLeg, effectiveAffinityLeg,
                        skillEffects.critBoostMultiplier, skillEffects.mindsEyeMultiplierHard, skillEffects.critElemMultiplier,
                        hitzoneInputs.isLegHardTarget
                     );

                     if (!isFinite(totalDmgLegPerHit)) {
                         console.error(`Damage per hit for ${attackName} on Leg is not finite.`);
                          calculationErrorOccurred = true;
                     } else {
                         const totalDmgLegForAttack = totalDmgLegPerHit * attack.hits;
                          if (!isFinite(totalDmgLegForAttack)) {
                              console.error(`Total damage for ${attackName} on Leg is not finite.`);
                               calculationErrorOccurred = true;
                         } else {
                              totalSequenceDamageLegOnly += totalDmgLegForAttack;
                         }
                     }
                }
            }

             if (!isFinite(totalSequenceDamageHeadOnly) || !isFinite(totalSequenceDamageLegOnly) || calculationErrorOccurred) {
                 console.error("Final total damage is not finite or an error occurred during hit calculation.", {totalSequenceDamageHeadOnly, totalSequenceDamageLegOnly});
                  resultsDivElement.innerHTML = '<h3>計算エラー</h3><p>合計ダメージの計算中に問題が発生しました。入力値を確認してください。</p>';
                  return;
             }

            resultsDivElement.innerHTML = `
                <h3>計算結果</h3>
                <p>選択した攻撃連携の合計ダメージ:</p>
                <ul>
                    <li>頭部のみ (100% 頭部): ${totalSequenceDamageHeadOnly.toFixed(2)}</li>
                    <li>足部のみ (100% 足部): ${totalSequenceDamageLegOnly.toFixed(2)}</li>
                </ul>

                <p>--- 詳細 ---</p>
                <p>真の攻撃力: ${trueRaw.toFixed(2)}</p>
                <p>真の属性値 (氷): ${trueElemental.toFixed(2)}</p>
                <p>頭部へのEffective会心率: ${effectiveAffinityHead.toFixed(2)}%</p>
                <p>足部へのEffective会心率: ${effectiveAffinityLeg.toFixed(2)}%</p>
                 <p>物理会心倍率 (超会心込み): ${skillEffects.critBoostMultiplier.toFixed(2)}x</p>
                 <p>属性会心倍率 (会心撃【属性】込み): ${skillEffects.critElemMultiplier.toFixed(2)}x</p>
                 <p>心眼 硬い部位物理倍率: ${skillEffects.mindsEyeMultiplierHard.toFixed(2)}x</p>
                 <p>物理斬れ味補正 (${getSharpnessColorName(weaponInputs.sharpnessColor)}): ${weaponInputs.sharpnessPhys.toFixed(2)}x</p> <p>属性斬れ味補正 (${getSharpnessColorName(weaponInputs.sharpnessColor)}): ${weaponInputs.sharpnessElem.toFixed(2)}x</p> `;
             console.log("Calculation finished, results displayed.");
        }

         // Helper to get sharpness color name for display
         const getSharpnessColorName = (key) => {
             switch (key) {
                 case 'yellow': return '黄';
                 case 'green': return '緑';
                 case 'blue': return '青';
                 case 'white': return '白';
                 // Add other colors if added later
                 default: return '不明';
             }
         };


        // --- Save/Load/Clear Functions ---

        function saveCurrentSettings() {
            const settingNameInput = document.getElementById('settingNameInput');
            if (!settingNameInput) { console.error("settingNameInput not found."); return; }
            const settingName = settingNameInput.value.trim();

            if (!settingName) {
                alert('設定名を入力してください。');
                return;
            }

            const settingsToSave = {
                weapon: getWeaponInputs(), // Now includes sharpnessColor
                hitzone: getHitzoneInputs(),
                skills: getSkillSettings(),
                attacks: {}
            };

            const attackCheckboxes = document.querySelectorAll('.attack-checkbox');
            attackCheckboxes.forEach(checkbox => {
                settingsToSave.attacks[checkbox.dataset.name] = checkbox.checked;
            });

            allSettings[settingName] = settingsToSave;
            saveAllSettingsToLocalStorage();

            alert(`設定 "${settingName}" を保存しました！`);
            settingNameInput.value = '';
            updateSettingListUI();
            closeSettingsModal();
        }

        function loadAllSettingsFromLocalStorage() {
            try {
                const savedSettings = localStorage.getItem(localStorageKey);
                allSettings = savedSettings ? JSON.parse(savedSettings) : {};
                 if (typeof allSettings !== 'object' || allSettings === null) {
                     console.warn("Loaded settings are not an object, resetting.");
                     allSettings = {};
                 }
            } catch (e) {
                console.error('Error loading settings from localStorage:', e);
                allSettings = {};
                alert('保存された設定の読み込みに失敗しました。');
            }
            updateSettingListUI();
        }

        function saveAllSettingsToLocalStorage() {
            try {
                localStorage.setItem(localStorageKey, JSON.stringify(allSettings));
            } catch (e) {
                console.error('Error saving settings to localStorage:', e);
                alert('全設定の保存に失敗しました。ブラウザのストレージ容量を確認してください。');
            }
        }

        function updateSettingListUI() {
            const selectElement = document.getElementById('savedSettingsSelect');
            if (!selectElement) { console.error("savedSettingsSelect not found in updateSettingListUI."); return; }
            selectElement.innerHTML = '<option value="">--選択してください--</option>';

            const sortedSettingNames = Object.keys(allSettings).sort();

            sortedSettingNames.forEach(settingName => {
                const option = document.createElement('option');
                option.value = settingName;
                option.textContent = settingName;
                selectElement.appendChild(option);
            });
        }

        function loadSelectedSetting() {
            const selectElement = document.getElementById('savedSettingsSelect');
             if (!selectElement) { console.error("savedSettingsSelect not found in loadSelectedSetting."); return; }
            const settingName = selectElement.value;

            if (!settingName) {
                alert('読み込む設定を選択してください。');
                return;
            }

            const settingsToLoad = allSettings[settingName];

            if (settingsToLoad) {
                 // Use optional chaining and nullish coalescing for robust loading
                document.getElementById('baseRaw').value = settingsToLoad.weapon?.baseRaw ?? document.getElementById('baseRaw')?.value ?? 0;
                document.getElementById('baseAffinity').value = settingsToLoad.weapon?.baseAffinity ?? document.getElementById('baseAffinity')?.value ?? 0;
                document.getElementById('baseDisplayElem').value = settingsToLoad.weapon?.baseDisplayElem ?? document.getElementById('baseDisplayElem')?.value ?? 0;
                // Load sharpness color
                 const sharpnessColorEl = document.getElementById('sharpnessColor');
                 if (sharpnessColorEl) {
                     sharpnessColorEl.value = settingsToLoad.weapon?.sharpnessColor ?? sharpnessColorEl.value;
                     // Validate if loaded value is a valid option, otherwise default
                     if (!sharpnessData.hasOwnProperty(sharpnessColorEl.value)) {
                         sharpnessColorEl.value = 'white'; // Default if loaded value is invalid
                     }
                 }
                // sharpnessPhys and sharpnessElem are calculated from sharpnessColor in getWeaponInputs()

                document.getElementById('hitzoneRawHead').value = settingsToLoad.hitzone?.hitzoneRawHead ?? document.getElementById('hitzoneRawHead')?.value ?? 0;
                document.getElementById('hitzoneElemHead').value = settingsToLoad.hitzone?.hitzoneElemHead ?? document.getElementById('hitzoneElemHead')?.value ?? 0;
                document.getElementById('hitzoneRawLeg').value = settingsToLoad.hitzone?.hitzoneRawLeg ?? document.getElementById('hitzoneRawLeg')?.value ?? 0;
                document.getElementById('hitzoneElemLeg').value = settingsToLoad.hitzone?.hitzoneElemLeg ?? document.getElementById('hitzoneElemLeg')?.value ?? 0;
                 document.getElementById('isLegHardTarget').checked = settingsToLoad.hitzone?.isLegHardTarget ?? document.getElementById('isLegHardTarget')?.checked ?? false;


                const skillIds = Object.keys(skillData);
                skillIds.forEach(skillId => {
                     const toggleElement = document.getElementById(skillId + 'Toggle');
                     const levelSelectElement = document.getElementById(skillId + 'LevelSelect');

                     if (toggleElement) {
                          const savedSkill = settingsToLoad.skills?.[skillId];
                         toggleElement.checked = savedSkill?.enabled ?? false;
                         toggleElement.dispatchEvent(new Event('change'));
                     }
                     if (levelSelectElement) {
                          const savedSkill = settingsToLoad.skills?.[skillId];
                         levelSelectElement.value = savedSkill?.level ?? levelSelectElement.value ?? levelSelectElement.options?.[0]?.value ?? 0;
                     }
                });

                const attackCheckboxes = document.querySelectorAll('.attack-checkbox');
                attackCheckboxes.forEach(checkbox => {
                    const attackName = checkbox.dataset.name;
                    checkbox.checked = settingsToLoad.attacks?.[attackName] ?? false;
                });

                alert(`設定 "${settingName}" を読み込みました！`);
                calculateTotalDamage();
                closeSettingsModal();
            } else {
                alert('選択された設定が見つかりません。');
            }
        }

        function deleteSelectedSetting() {
            const selectElement = document.getElementById('savedSettingsSelect');
             if (!selectElement) { console.error("savedSettingsSelect not found in deleteSelectedSetting."); alert('エラーが発生しました。ページを再読み込みしてください。'); return; }
            const settingName = selectElement.value;

            if (!settingName) {
                alert('削除する設定を選択してください。');
                return;
            }

            if (confirm(`設定 "${settingName}" を削除しますか？`)) {
                if (allSettings.hasOwnProperty(settingName)) {
                    delete allSettings[settingName];
                    saveAllSettingsToLocalStorage();
                    alert(`設定 "${settingName}" を削除しました。`);
                    updateSettingListUI();
                } else {
                    alert('選択された設定が見つかりません。');
                }
            }
        }

        function clearAllSettings() {
             if (confirm('全ての保存された設定をクリアしますか？この操作は元に戻せません。')) {
                try {
                    localStorage.removeItem(localStorageKey);
                    allSettings = {};
                    alert('全ての保存設定をクリアしました。');
                    updateSettingListUI();
                } catch (e) {
                     console.error('Error clearing settings:', e);
                     alert('設定のクリアに失敗しました。');
                }
             }
        }

         // --- Skill Toggle and Level Select Linkage ---
         function setupSkillControls() {
             const skillItems = document.querySelectorAll('.skill-item');
             skillItems.forEach(item => {
                 const checkbox = item.querySelector('input[type="checkbox"][data-skill-id]');
                 const select = item.querySelector('select[data-skill-id]');

                 if (checkbox && select) {
                     const updateSelectState = () => {
                         select.disabled = !checkbox.checked;
                     };
                     updateSelectState();
                     checkbox.addEventListener('change', updateSelectState);
                 }
             });
         }

        // --- Modal Control ---
        const settingsModalOverlay = document.getElementById('settingsModalOverlay');
        const settingsModalDialog = document.getElementById('settingsModalDialog');

        function openSettingsModal() {
             if (!settingsModalOverlay || !settingsModalDialog) { console.error("Modal elements not found."); return; }
             updateSettingListUI();
             settingsModalOverlay.classList.add('visible');
        }

        function closeSettingsModal() {
             if (settingsModalOverlay) { settingsModalOverlay.classList.remove('visible'); }
        }

         // Close modal when clicking outside the dialog
         if (settingsModalOverlay) {
             settingsModalOverlay.addEventListener('click', closeSettingsModal);
         }

        // Prevent closing modal when clicking inside the dialog
         if (settingsModalDialog) {
             settingsModalDialog.addEventListener('click', function(event) {
                 event.stopPropagation();
             });
         }


        // --- Initialize on page load ---
        window.onload = function() {
             resultsDivElement = document.getElementById('results'); // Get results div once
             setTimeout(() => {
                 setupSkillControls();
                 loadAllSettingsFromLocalStorage();
             }, 200);
        };

    </script>

</body>
</html>